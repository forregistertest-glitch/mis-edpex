# รายงานวิเคราะห์ระบบนำเข้า/ส่งออก โมดูลนิสิต (Student Import/Export Analysis)

| Field | Value |
|:------|:------|
| **Version** | 1.03 |
| **Last Updated** | 2026-02-19T06:30:00+07:00 |

---

## 1. คำตอบ: หน้า /seed ซ้ำข้อมูลหรือไม่?

**ไม่ซ้ำครับ** — เพราะ code ใช้ `setDoc(..., { merge: true })` ซึ่งหมายความว่า:

| กรณี | ผลลัพธ์ |
|:---|:---|
| นิสิตรหัส `6014900080` **ยังไม่มี**ในระบบ | สร้างใหม่ |
| นิสิตรหัส `6014900080` **มีอยู่แล้ว** | อัปเดตเฉพาะ field ที่ส่งไป ไม่ลบ field อื่น |

> อาจารย์: ใช้ `doc(collection(db, "advisors"))` ซึ่งสร้าง Auto-ID → **กด Seed ซ้ำ = เพิ่มอาจารย์ซ้ำได้** (ปัญหาเล็กน้อย ลบได้ในหน้า /advisor)

---

## 2. สถานะปัจจุบันของระบบนำเข้า/ส่งออก

### 2.1 การนำเข้า (Import) — 4 โหมด

| โหมด | รองรับ Header | Collection ปลายทาง | สถานะ |
|:---|:---|:---|:---|
| **ข้อมูลนิสิต** | รหัสนิสิต, ชื่อ, เพศ, ระดับปริญญา, สาขา, อาจารย์ ฯลฯ (30+ header maps) | `graduate_students` | ✅ ทำงานได้ |
| **ผลงานตีพิมพ์** | รหัสนิสิต, ชื่อบทความ, วารสาร, ปี, Quartile, น้ำหนัก | `student_publications` | ✅ ทำงานได้ |
| **ความก้าวหน้า** | รหัสนิสิต, หัวข้อ, สถานะ, วันที่สอบ, ภาค, ปี | `student_progress` | ✅ ทำงานได้ |
| **Smart Import** | รวมทั้ง 3 แบบใน Excel 1 ไฟล์ (ดู Sheet name) | ทั้ง 3 collections | ✅ ทำงานได้ |

### 2.2 การส่งออก (Export) — 2 ปุ่ม

| ปุ่ม | ผลลัพธ์ | Sheet ในไฟล์ |
|:---|:---|:---|
| **ส่งออก (แสดงผล)** | Excel 1 ไฟล์ เฉพาะนิสิตที่กรองอยู่ | Sheet 1: Students |
| **ส่งออก (ทั้งหมด)** | Excel 1 ไฟล์ รวมข้อมูลทั้งหมด | Sheet 1: Students + Sheet 2: Publications + Sheet 3: Progress |

---

## 3. เปรียบเทียบ 6 CSV ต้นฉบับ vs ข้อมูลปัจจุบันในระบบ

### 6 ไฟล์ CSV ใน `source/academic/`:

| # | ชื่อไฟล์ CSV | ประเภท | ระบบรองรับ? |
|:---|:---|:---|:---|
| 1 | `_การตีพิมพ์ผลงาน.csv` | ข้อมูลดิบ (Publication) | ⚠️ **บางส่วน** |
| 2 | `_นิสิตคงอยู่ สำเร็จ.csv` | ข้อมูลกรอง (status=คงอยู่/สำเร็จ) | ⚠️ **บางส่วน** |
| 3 | `_นิสิตสละสิทธิ์ ไม่มารายงานตัว.csv` | ข้อมูลกรอง (status=สละสิทธิ์) | ⚠️ **บางส่วน** |
| 4 | `_รายงานความก้าวหน้า.csv` | ข้อมูลดิบ (Progress) | ❌ **ไม่ตรง** |
| 5 | `_สรุปนิสิตจบแยกตามปีเข้า.csv` | ตารางสรุป (Aggregated) | ❌ **ยังไม่มี** |
| 6 | `_สรุปอาจารย์ที่ปรึกษา.csv` | ตารางสรุป (Grouped by advisor) | ❌ **ยังไม่มี** |

### รายละเอียด Gap แต่ละไฟล์:

#### CSV 1: การตีพิมพ์ผลงาน
**Header ต้นฉบับ:** ลำดับ, รหัสนิสิต, ชื่อ-นามสกุล, ระดับ, สาขาวิชา, ชื่ออาจารย์ที่ปรึกษาหลัก, ชื่อบทความ, ชื่อวารสาร, เผยแพร่ระหว่างวันที่, ปีที่, ฉบับที่, เลขหน้า, วันที่ตอบรับ, ปีที่ตีพิมพ์, ระดับการเผยแพร่, วันที่อนุมัติปริญญา, ฐานข้อมูล, แผนการเรียน

**Gap:** คอลัมน์ที่ระบบยังไม่มีใน StudentPublication:
- `ระดับ` (degree_level → ต้อง join จาก student)
- `สาขาวิชา` (major_name → ต้อง join จาก student)
- `ชื่ออาจารย์ที่ปรึกษาหลัก` (advisor_name → ต้อง join จาก student)
- `เผยแพร่ระหว่างวันที่`, `ปีที่`, `ฉบับที่`, `เลขหน้า` (ยังไม่มี field)
- `วันที่ตอบรับให้ตีพิมพ์` (ยังไม่มี field)
- `ระดับการเผยแพร่` (ยังไม่มี field)
- `วันที่อนุมัติปริญญา` (ยังไม่มี field)

#### CSV 2-3: นิสิตคงอยู่/สำเร็จ + นิสิตสละสิทธิ์
**Header:** เหมือน Student Profile ปกติ (รหัส, ชื่อ, เพศ, ระดับ, สาขา, อาจารย์, ภาค, ปี, สถานะ ฯลฯ)

**Gap:** Export ปัจจุบัน **รวมทุกสถานะเป็น Sheet เดียว** → ต้องเพิ่ม logic แยก Sheet ตาม `current_status`

#### CSV 4: รายงานความก้าวหน้า
**Header ต้นฉบับ (55 columns):** STUDENT_ID, SEX, PRENAME_TH, NAME_TH, ... ADVISOR_NAME_TH, COMMITTEE_SET, COMMIT_DATE, THESIS_TH, THESIS_EN, PROPOSAL_SUBMIT, PROP_DATE, ENGEXAM_STATUS, ENGEXAM_DATE, STUDYPLAN_SUBMIT, STUDYPLAN_DATE, COMPREHENSIVE_WRITING_STATUS, ... QUALIFYEXAM_WRITING_STATUS, ... DEFENDEXAM_STATUS, DEFEND_DATE, MANUSCRIPT_STATUS, MANUSCRIPT_DATE

**Gap:** โครงสร้างต่างจากระบบปัจจุบันโดยสิ้นเชิง!
- CSV ต้นฉบับ: **1 แถว = 1 นิสิต** มีทุก milestone เป็นคอลัมน์แนวนอน (Wide format)
- ระบบ ปัจจุบัน: `student_progress` collection เก็บ **1 แถว = 1 milestone** (Long format)
- ต้องเขียน **Pivot logic** เพื่อ export แบบ Wide format

#### CSV 5: สรุปนิสิตจบแยกตามปีเข้า
**โครงสร้าง:** Pivot table — แถว = ปีเข้า, คอลัมน์ = ปีจบ (2560-2568), แต่ละช่อง = จำนวนจบ/คงอยู่

**Gap:** เป็นตาราง **Aggregated/Computed** — ต้องเขียน logic คำนวณจากข้อมูล Student ทั้งหมด ยังไม่มี

#### CSV 6: สรุปอาจารย์ที่ปรึกษา
**โครงสร้าง:** Group by อาจารย์ → แสดงรายชื่อนิสิตในสังกัด + สถานะ

**Gap:** UI มี (ปุ่ม Eye ในหน้า /advisor) แต่ **Export ยังไม่มี**

---

## 4. สรุป: สิ่งที่ต้องทำเพิ่มเพื่อให้ Export ได้ 6 CSV ตรงกับต้นฉบับ

| ลำดับ | งาน | ความยาก | หมายเหตุ |
|:---|:---|:---|:---|
| 1 | เพิ่ม field ใน `StudentPublication` (ปีที่, ฉบับที่, เลขหน้า, วันที่ตอบรับ ฯลฯ) | ปานกลาง | ต้องแก้ type, form, import, export |
| 2 | Export แยก Sheet ตาม status (คงอยู่/สำเร็จ vs สละสิทธิ์) | ง่าย | filter แล้วเขียนแยก Sheet |
| 3 | Export ความก้าวหน้าแบบ Wide format (Pivot) | **ยาก** | ต้องเขียน pivot: Long → Wide (55 columns) |
| 4 | สร้างตาราง Pivot สรุปจบแยกตามปีเข้า | **ยาก** | aggregation + cross-tab |
| 5 | Export สรุปอาจารย์ที่ปรึกษา (Group by advisor) | ปานกลาง | group + join students |

> **ประมาณการเวลา:** งาน 1-5 ทั้งหมดน่าจะใช้เวลาอีก 1-2 session

---
*Document v.1.03*
